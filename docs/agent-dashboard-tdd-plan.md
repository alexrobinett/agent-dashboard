# Agent Dashboard - TDD + CI/CD Implementation Plan

**Project:** agent-dashboard  
**Repo:** github.com/alexrobinett/agent-dashboard  
**Approach:** Test-Driven Development with CI/CD gating  
**Status:** PLANNING - Do not start implementation

---

## 1. Repository Structure

```
agent-dashboard/
├── .github/
│   └── workflows/
│       ├── ci.yml                 # PR checks: lint, typecheck, test
│       ├── e2e.yml                # Playwright E2E tests
│       └── deploy.yml             # Production deploy to Cloudflare
├── convex/
│   ├── _generated/               # Auto-generated by convex
│   ├── schema.ts                 # Database schema
│   ├── http.ts                   # REST API endpoints
│   ├── tasks.ts                  # Task queries/mutations
│   ├── workload.ts               # Agent workload queries
│   ├── push.ts                   # Push notification actions
│   ├── auth.ts                   # Authentication helpers
│   └── test/                     # Convex function tests
│       ├── setup.ts              # Test fixtures
│       ├── tasks.test.ts         # Task query tests
│       └── http.test.ts          # HTTP action tests
├── src/
│   ├── components/
│   │   ├── ui/                   # shadcn/ui components
│   │   ├── kanban/
│   │   │   ├── KanbanBoard.tsx
│   │   │   ├── KanbanColumn.tsx
│   │   │   └── TaskCard.tsx
│   │   ├── task/
│   │   │   ├── TaskDetailModal.tsx
│   │   │   ├── TaskForm.tsx
│   │   │   └── TaskFilters.tsx
│   │   └── layout/
│   │       ├── Navigation.tsx
│   │       ├── Sidebar.tsx
│   │       └── ThemeProvider.tsx
│   ├── hooks/
│   │   ├── useTasks.ts           # TanStack Query hooks
│   │   ├── useWorkload.ts
│   │   └── useRealtime.ts        # Subscription management
│   ├── lib/
│   │   ├── convex.ts             # Convex client setup
│   │   ├── utils.ts              # Utilities
│   │   └── constants.ts          # App constants
│   ├── routes/
│   │   ├── __root.tsx            # Root layout
│   │   ├── dashboard.tsx         # Main kanban view
│   │   ├── workload.tsx          # Agent workload view
│   │   └── settings.tsx          # User preferences
│   ├── styles/
│   │   └── globals.css           # Tailwind + custom CSS
│   ├── test/
│   │   ├── setup.ts              # Vitest setup
│   │   ├── mocks/
│   │   │   └── convex.ts         # Mock Convex client
│   │   └── components/
│   │       └── KanbanBoard.test.tsx
│   └── types/
│       └── index.ts              # Shared TypeScript types
├── e2e/
│   ├── fixtures/
│   │   └── tasks.ts              # E2E test data
│   ├── tests/
│   │   ├── dashboard.spec.ts     # Dashboard E2E tests
│   │   ├── task-crud.spec.ts     # Task create/update/delete
│   │   └── realtime.spec.ts      # WebSocket update tests
│   └── playwright.config.ts
├── public/
│   └── favicon.ico
├── .env.example
├── .env.local.example
├── convex.json                   # Convex deployment config
├── package.json
├── tsconfig.json
├── vite.config.ts
├── tailwind.config.ts
└── README.md
```

---

## 2. Technology Stack

| Layer | Technology | Version | Purpose |
|-------|------------|---------|---------|
| Framework | TanStack Start | Latest | Full-stack React with SSR |
| State | TanStack Query | v5 | Server state management |
| Real-time | Convex | Latest | Database + WebSocket |
| Styling | Tailwind CSS | v3 | Utility CSS |
| UI | shadcn/ui | Latest | Component library |
| Testing (Unit) | Vitest | Latest | Component/function tests |
| Testing (E2E) | Playwright | Latest | Browser automation |
| Linting | ESLint + Prettier | Latest | Code quality |
| Types | TypeScript | v5 | Type safety |
| Deploy | Cloudflare Pages | - | Static hosting |

---

## 3. CI/CD Pipeline

### 3.1 CI Workflow (`.github/workflows/ci.yml`)

**Triggers:** PR to `main`, push to `main`

```yaml
jobs:
  lint:
    - Checkout
    - pnpm install
    - pnpm run lint
    - pnpm run typecheck

  test:
    - Checkout
    - pnpm install
    - pnpm run test:unit
    - Upload coverage to Codecov

  convex-test:
    - Checkout
    - pnpm install
    - npx convex dev & (background)
    - pnpm run test:convex
    - Requires CONVEX_DEPLOY_KEY

  build:
    - Checkout
    - pnpm install
    - pnpm run build
    - Verify no build errors
```

**Failure Policy:** Any job fails → PR blocked from merge

### 3.2 E2E Workflow (`.github/workflows/e2e.yml`)

**Triggers:** PR labeled `e2e-required`, nightly on `main`

```yaml
jobs:
  e2e:
    - Checkout
    - pnpm install
    - npx convex deploy --preview
    - pnpm run build --mode staging
    - npx playwright install
    - pnpm run test:e2e
    - Upload Playwright report
    - Comment PR with results
```

### 3.3 Deploy Workflow (`.github/workflows/deploy.yml`)

**Triggers:** Push to `main` (after CI passes)

```yaml
jobs:
  deploy:
    needs: [ci, e2e]  # Must pass both
    - Checkout
    - pnpm install
    - npx convex deploy
    - pnpm run build
    - Deploy to Cloudflare Pages
    - Post deploy URL to Slack/Discord
```

### 3.4 Visual Regression (`.github/workflows/visual.yml`)

**Triggers:** PR with UI changes, manual dispatch

```yaml
jobs:
  visual:
    - Checkout
    - pnpm install
    - Build Storybook
    - Run Chromatic visual tests
    - Comment PR with UI diff
    - Block merge on unreviewed changes
```

**Tool:** Chromatic (or Percy) for pixel-perfect UI diffs

---

## 4. TDD Strategy

### 4.1 Test Pyramid

```
        /\
       /  \
      / E2E \        <- 5% (critical paths)
     /--------\
    /  Integration \   <- 15% (API + components)
   /----------------\
  /    Unit Tests     \ <- 80% (functions, components)
 /----------------------\
```

### 4.2 Test-Driven Workflow

**For every task:**
1. **RED:** Write failing test first
2. **GREEN:** Implement minimal code to pass
3. **REFACTOR:** Clean up, maintain test coverage
4. **COMMIT:** PR with tests + implementation

### 4.3 Test Categories

| Type | Tool | Location | Coverage Target |
|------|------|----------|-----------------|
| Unit | Vitest | `src/**/*.test.ts` | 80% |
| Component | Vitest + RTL | `src/components/**/*.test.tsx` | 70% |
| Convex | convex-test | `convex/test/*.test.ts` | 60% |
| E2E | Playwright | `e2e/tests/*.spec.ts` | Critical paths |

---

## 5. Implementation Phases

### UI/UX Quality Gates (All Phases)

**Before ANY UI task moves to Done:**
- [ ] Visual matches approved design from `dashboard-design/` mocks
- [ ] Screenshots compared in PR (actual vs design spec)
- [ ] Mobile viewport tested (iPhone SE, iPhone 14 Pro, iPad)
- [ ] Dark mode polish check
- [ ] Animation smoothness (60fps, subtle, purposeful)
- [ ] Micro-interactions present (hover states, focus rings, loading skeletons)

**Design Review Checkpoints:**
- End of Phase 2: Component library visual review
- End of Phase 3: Dashboard UX flow review  
- End of Phase 4: Mobile-responsive pass with real devices
- End of Phase 5: Polish week (animations, transitions, delight)

### Phase 0: Infrastructure (Week 0)
**Goal:** Repo setup with CI/CD gating

| Task | Description | Tests | Est |
|------|-------------|-------|-----|
| 0.1 | Create `agent-dashboard` repo | CI passes | 2h |
| 0.2 | Setup TanStack Start + Convex | `pnpm dev` works | 4h |
| 0.3 | Configure CI pipeline | All jobs green | 4h |
| 0.4 | Setup shadcn/ui + Tailwind | Theme toggle works | 2h |
| 0.5 | Configure E2E with Playwright | `pnpm test:e2e` passes | 4h |

**Gate:** All CI jobs must pass before Phase 1 starts

---

### Phase 1: Schema + API Foundation (Week 1)
**Goal:** Backend ready with tests

| Task | Description | Test File | Est |
|------|-------------|-----------|-----|
| 1.1 | Schema: pushTokens table | `schema.test.ts` | 2h |
| 1.2 | Schema: activityLog table | `schema.test.ts` | 2h |
| 1.3 | HTTP: CORS + health endpoint | `http.test.ts` | 2h |
| 1.4 | HTTP: GET /api/board | `http.test.ts` | 4h |
| 1.5 | HTTP: GET /api/tasks with filters | `http.test.ts` | 4h |
| 1.6 | HTTP: POST/PATCH /api/tasks | `http.test.ts` | 4h |
| 1.7 | HTTP: GET /api/workload | `http.test.ts` | 2h |
| 1.8 | Convex: getBoard query | `tasks.test.ts` | 4h |
| 1.9 | Convex: getWorkload query | `workload.test.ts` | 2h |

**Gate:** 100% API test coverage, all endpoints documented

---

### Phase 2: Core UI Components (Week 2)
**Goal:** Design system implemented with pixel-perfect fidelity

| Task | Description | Acceptance Criteria | Est |
|------|-------------|---------------------|-----|
| 2.1 | Theme provider + tokens | Dark mode matches design spec exactly | 2h |
| 2.2 | Navigation component | Matches Monday.com-style sidebar, collapsible | 4h |
| 2.3 | **TaskCard component** | **CRITICAL:** Priority borders, agent badges, hover lift, exact spacing from design system | 6h |
| 2.4 | KanbanColumn component | Drop shadows, column headers with counts | 4h |
| 2.5 | **KanbanBoard component** | **CRITICAL:** Smooth drag-drop (desktop), press-hold (mobile), real-time updates | 8h |
| 2.6 | Priority badges | Monday.com-style colored pills, not just dots | 3h |
| 2.7 | Agent badges | Circular avatars with initials, color-coded | 2h |
| 2.8 | Status indicators | Full pills (Linear) + minimal dots (mobile) variants | 3h |
| 2.9 | **Loading skeletons** | **CRITICAL:** Animated skeletons matching card structure | 2h |
| 2.10 | Empty states | Illustrative empty states, not just text | 2h |

**Gate:** 
- [ ] Side-by-side comparison with design mocks passes
- [ ] Visual regression tests establish baseline
- [ ] Mobile viewport (375px) looks native, not cramped
- [ ] Animations feel 60fps smooth

---

### Phase 3: Dashboard Views (Week 3)
**Goal:** Full dashboard with real-time updates

| Task | Description | Test File | Est |
|------|-------------|-----------|-----|
| 3.1 | Dashboard route layout | `dashboard.test.tsx` | 4h |
| 3.2 | Integrate KanbanBoard with Convex | `dashboard.e2e.ts` | 6h |
| 3.3 | Task detail modal | `TaskDetailModal.test.tsx` | 6h |
| 3.4 | Create task dialog | `CreateTaskDialog.test.tsx` | 4h |
| 3.5 | Task filters UI | `TaskFilters.test.tsx` | 4h |
| 3.6 | Real-time subscription hook | `useRealtime.test.ts` | 4h |
| 3.7 | Loading/error states | `dashboard.test.tsx` | 2h |

**Gate:** E2E tests pass for dashboard CRUD operations

---

### Phase 4: Workload + Health (Week 4)
**Goal:** Agent visibility and monitoring

| Task | Description | Test File | Est |
|------|-------------|-----------|-----|
| 4.1 | Workload view route | `workload.test.tsx` | 4h |
| 4.2 | Agent capacity bars | `AgentCapacity.test.tsx` | 4h |
| 4.3 | Task distribution chart | `TaskDistribution.test.tsx` | 4h |
| 4.4 | Health dashboard | `health.test.tsx` | 4h |
| 4.5 | Blocked tasks alert | `BlockedAlert.test.tsx` | 2h |
| 4.6 | Mobile responsive pass | visual regression | 4h |

**Gate:** Mobile viewport tests pass

---

### Phase 5: Polish + iOS Prep (Week 5)
**Goal:** Production ready, iOS-compatible API

| Task | Description | Acceptance Criteria | Est |
|------|-------------|---------------------|-----|
| 5.1 | Push token registration API | `push.test.ts` | 4h |
| 5.2 | Activity log UI | `ActivityLog.test.tsx` | 4h |
| 5.3 | Settings page | `settings.test.tsx` | 4h |
| 5.4 | Keyboard shortcuts | `shortcuts.e2e.ts` | 2h |
| 5.5 | **POLISH WEEK: Animations** | **CRITICAL:** Task card enter/exit, column transitions, modal springs | 6h |
| 5.6 | **POLISH WEEK: Micro-interactions** | **CRITICAL:** Button press states, hover reveals, pull-to-refresh | 4h |
| 5.7 | **POLISH WEEK: Theming** | **CRITICAL:** System theme sync, accent color options | 4h |
| 5.8 | Performance optimization | Lighthouse CI | 4h |
| 5.9 | Accessibility audit | a11y tests | 4h |
| 5.10 | Documentation | - | 4h |

**Gate:** 
- [ ] Lighthouse score >90
- [ ] a11y tests pass
- [ ] **"Feels native" test on real devices**

---

## 6. Definition of Done (Per Task)

- [ ] Tests written first (RED → GREEN)
- [ ] Implementation passes tests
- [ ] TypeScript strict mode passes
- [ ] No ESLint warnings
- [ ] Visual matches design spec (if UI)
- [ ] PR reviewed and approved
- [ ] CI passes (lint, test, build)
- [ ] Squash merged to `main`

---

## 7. Definition of Ready (Before Starting)

- [ ] Design approved (from dashboard-design/)
- [ ] API contract documented (from PRD)
- [ ] Dependencies clear
- [ ] Test strategy defined
- [ ] Acceptance criteria specific
- [ ] Estimated and assigned

---

## 8. Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Convex subscription performance | Load test at 100+ tasks in Phase 1 |
| Mobile UX issues | Weekly mobile-first reviews |
| iOS API compatibility | iOS spike in Phase 5 (before iOS dev) |
| Scope creep | Strict "Definition of Ready" gating |
| Test flakiness | Retry logic in CI, stable selectors |

---

## 9. Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Test Coverage | >70% | Codecov report |
| Build Time | <2min | CI logs |
| E2E Flake Rate | <2% | Playwright history |
| Lighthouse | >90 | CI audit |
| Bundle Size | <200KB | Build report |
| Time to Interactive | <2s | Lighthouse |

---

**Next Step:** Review this plan, then create GitHub issues for each task in Phase 0-1 to kick off development.

**Do not start implementation until:**
1. This plan is reviewed and approved
2. GitHub repo is created
3. Initial CI pipeline is green
