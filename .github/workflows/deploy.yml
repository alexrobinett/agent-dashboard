name: Deploy

on:
  push:
    branches: [main]

env:
  VITE_CONVEX_URL: https://curious-dolphin-134.convex.cloud

jobs:
  # â”€â”€ Pre-deploy gates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-deploy:
    name: Pre-deploy gates (typecheck Â· test Â· build)
    runs-on: ubuntu-latest
    outputs:
      build-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate stub files for CI
        run: bash scripts/generate-stubs.sh

      - name: Type check
        run: pnpm typecheck

      - name: Unit tests
        run: pnpm test

      - name: Build
        run: pnpm build

      - name: Compute cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-build-${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vinxi
            .output
          key: ${{ steps.cache-key.outputs.key }}

  # â”€â”€ Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: pre-deploy
    outputs:
      deploy-url: ${{ steps.set-url.outputs.deploy-url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vinxi
            .output
          key: ${{ needs.pre-deploy.outputs.build-key }}

      # â”€â”€ Deploy: Cloudflare Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy to Cloudflare Pages
        run: npx wrangler@3 pages deploy .output/public --project-name=agent-dashboard
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # â”€â”€ Deploy: Vercel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Only runs when Vercel secrets are configured.
      - name: Deploy to Vercel
        id: vercel-deploy
        if: ${{ env.VERCEL_TOKEN != '' && env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != '' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          pnpm add -g vercel@latest
          DEPLOY_URL=$(vercel --prod --token "$VERCEL_TOKEN" --yes 2>&1 | tail -1)
          echo "DEPLOY_URL=$DEPLOY_URL" >> "$GITHUB_ENV"
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      - name: Set deploy URL output
        id: set-url
        run: |
          URL="${{ steps.vercel-deploy.outputs.url }}"
          # Fall back to the Convex HTTP URL if no Vercel deploy happened
          if [ -z "$URL" ]; then
            URL="${{ env.VITE_CONVEX_URL }}"
          fi
          echo "deploy-url=$URL" >> "$GITHUB_OUTPUT"

  # â”€â”€ Post-deploy health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: Post-deploy health check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Health check (3 attempts, 10 s gap)
        id: health
        env:
          DEPLOY_URL: ${{ needs.deploy.outputs.deploy-url }}
        run: |
          HEALTH_URL="${DEPLOY_URL%/}/api/health"
          echo "Checking $HEALTH_URL"
          for attempt in 1 2 3; do
            echo "--- Attempt $attempt ---"
            HTTP_STATUS=$(curl -s -o /tmp/health_body.json -w "%{http_code}" "$HEALTH_URL" || echo "000")
            echo "HTTP status: $HTTP_STATUS"
            cat /tmp/health_body.json || true
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Health check passed âœ…"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then
              echo "Retrying in 10 sâ€¦"
              sleep 10
            fi
          done
          echo "Health check FAILED after 3 attempts âŒ"
          echo "healthy=false" >> "$GITHUB_OUTPUT"
          exit 1

      # â”€â”€ Open GitHub issue on health-check failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Open GitHub issue for broken deploy
        if: failure() && steps.health.outputs.healthy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_URL: ${{ needs.deploy.outputs.deploy-url }}
        run: |
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "ğŸš¨ Deploy health check failed ($(date -u '+%Y-%m-%d %H:%M UTC'))" \
            --body "## Deploy health check failure

          **Commit:** \`${{ github.sha }}\`
          **Branch:** \`${{ github.ref_name }}\`
          **Deploy URL:** ${DEPLOY_URL}
          **Triggered by:** ${{ github.actor }}

          The \`/api/health\` endpoint did not return HTTP 200 after 3 attempts (10 s gap each).

          ### Next steps
          1. Check the Vercel/Convex deployment logs for errors.
          2. Verify that \`/api/health\` returns \`{ \"status\": \"ok\" }\`.
          3. Close this issue once the incident is resolved.

          cc @${{ github.actor }}" \
            --label "bug,deployment"

      # â”€â”€ Discord: success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” success
        if: success() && steps.health.outputs.healthy == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOY_URL: ${{ needs.deploy.outputs.deploy-url }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not configured, skipping notification."
            exit 0
          fi
          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Deploy succeeded â€” agent-dashboard",
                "color": 3066993,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.sha }}"'", "inline": true},
                  {"name": "Author", "value": "'"${{ github.actor }}"'", "inline": true},
                  {"name": "URL", "value": "'"$DEPLOY_URL"'", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

      # â”€â”€ Discord: failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOY_URL: ${{ needs.deploy.outputs.deploy-url }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not configured, skipping notification."
            exit 0
          fi
          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Deploy health check FAILED â€” agent-dashboard",
                "color": 15158332,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.sha }}"'", "inline": true},
                  {"name": "Author", "value": "'"${{ github.actor }}"'", "inline": true},
                  {"name": "URL", "value": "'"$DEPLOY_URL"'", "inline": false},
                  {"name": "Action", "value": "A GitHub issue has been opened to track this.", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

  # â”€â”€ Notify Discord on pre-deploy / build failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-build-failure:
    name: Notify Discord â€” build/test failure
    runs-on: ubuntu-latest
    needs: [pre-deploy, deploy]
    if: failure() && (needs.pre-deploy.result == 'failure' || needs.deploy.result == 'failure')

    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not configured, skipping notification."
            exit 0
          fi
          FAILED_JOB="pre-deploy/build"
          if [ "${{ needs.pre-deploy.result }}" = "failure" ]; then
            FAILED_JOB="pre-deploy (typecheck / test / build)"
          elif [ "${{ needs.deploy.result }}" = "failure" ]; then
            FAILED_JOB="deploy"
          fi
          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ CI/CD pipeline failed â€” agent-dashboard",
                "color": 15158332,
                "fields": [
                  {"name": "Failed job", "value": "'"$FAILED_JOB"'", "inline": false},
                  {"name": "Commit", "value": "'"${{ github.sha }}"'", "inline": true},
                  {"name": "Author", "value": "'"${{ github.actor }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
