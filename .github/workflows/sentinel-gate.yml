name: Sentinel Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  statuses: read

jobs:
  sentinel-review-check:
    name: Sentinel Review Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine risk tier
        id: risk
        run: |
          if [[ ! -f .github/risk-policy.json ]]; then
            echo "tier=low" >> $GITHUB_OUTPUT
            echo "No risk-policy.json found, defaulting to low"
            exit 0
          fi

          CHANGED_FILES=$(gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '[.[].filename] | join("\n")')

          TIER="low"
          while IFS= read -r pattern; do
            # Convert glob to regex safely using bash parameter expansion
            regex="${pattern//\*\*/DOUBLESTAR}"
            regex="${regex//\*/[^/]*}"
            regex="${regex//DOUBLESTAR/.*}"
            if echo "$CHANGED_FILES" | grep -qE "^${regex}$"; then
              TIER="high"
              break
            fi
          done < <(jq -r '.riskTierRules.high[]' .github/risk-policy.json)

          echo "tier=$TIER" >> $GITHUB_OUTPUT
          echo "Detected risk tier: $TIER"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check Sentinel review status
        if: steps.risk.outputs.tier == 'high'
        run: |
          SHA="${{ github.event.pull_request.head.sha }}"
          REPO="${{ github.repository }}"

          STATUS=$(gh api /repos/$REPO/commits/$SHA/statuses \
            --jq '[.[] | select(.context == "sentinel-review")] | .[0].state // "pending"')

          echo "Sentinel review status for $SHA: $STATUS"

          if [[ "$STATUS" == "success" ]]; then
            echo "✅ Sentinel approved this commit"
          elif [[ "$STATUS" == "failure" ]]; then
            echo "❌ Sentinel requested changes — cannot merge until addressed"
            exit 1
          else
            echo "⏳ No Sentinel review found for this commit yet"
            echo "High-risk changes require Sentinel review before merge"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Low-risk path
        if: steps.risk.outputs.tier == 'low'
        run: echo "✅ Low-risk change — Sentinel review not required"
